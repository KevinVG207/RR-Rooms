<!DOCTYPE html>
<html>
    <head>
        <title>Retro Rewind Rooms Viewer</title>
        <meta name="description" content="View rooms and players currently playing Retro Rewind, a custom track distribution for Mario Kart Wii by ZPL."/>
        <meta name="author" content="KevinVG207" />
        <meta name="keywords" content="mario kart wii, mkwii, retro rewind, zpl, rooms, online, multiplayer, ctgp" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <!-- <link rel="shortcut icon" href="favicon.ico" type="image/vnd.microsoft.icon" /> -->
        <link rel="stylesheet" href="./style.css" type="text/css" />
        <link href="./ctmkf.css" rel="Stylesheet" type="text/css" />
    </head>
    <body>
        <h1><a href="?" id="home-link">Retro Rewind Room Viewer</a></h1>
        <div id="loading">Fetching data. Please wait...</div>
        <div id="top-container"><span>No. of rooms: <span id="no-rooms" class="top-stat">0</span></span><span>No. of players: <span id="no-players" class="top-stat">0</span></span></div>
        <table>
            <tbody id="tablebody"></tbody>
        </table>
        <p><a href="https://wiki.tockdom.com/wiki/Retro_Rewind" target="_blank">Retro Rewind</a> is a custom track distribution for Mario Kart Wii, created by ZPL.</p>
        <p>This webpage is created by <a href="https://github.com/KevinVG207" target="_blank">KevinVG207</a></p>
        <p>Room data taken from <a href="http://zplwii.xyz/api/groups" target="_blank">this</a> API endpoint.</p>
        <p><a href="https://wiki.tockdom.com/wiki/CTMKF" target="_blank">Chadderz's Terrible Mario Kart Font</a> is used for the Mii name special symbols.</p>
        <script type="text/javascript">
            const MAX_MIIS_PER_REQUEST = 24;
            const EXPIRE_TIME = 1000 * 60 * 60 * 24 * 7; // 1 week

            // Miis are stored as key "mii_{data}": "[image, datetime]"
            function remove_expired_mii_images(){
                let remove_keys = [];

                for (let i = 0; i < localStorage.length; i++){
                    const key = localStorage.key(i);

                    if (key.startsWith("mii_")){
                        const mii_data = JSON.parse(localStorage.getItem(key));

                        if (Date.now() - mii_data[1] > EXPIRE_TIME){
                            remove_keys.push(key);
                        }
                    }

                    for (const key of remove_keys){
                        localStorage.removeItem(key);
                    }
                }
            }

            function get_cached_mii_image(mii_data){
                const mii_data_key = `mii_${mii_data}`;
                const mii_data_str = localStorage.getItem(mii_data_key);

                if (!mii_data_str){
                    return null;
                }

                const mii_data_arr = JSON.parse(mii_data_str);

                if (Date.now() - mii_data_arr[1] > EXPIRE_TIME){
                    localStorage.removeItem(mii_data_key);
                    return null;
                }

                return mii_data_arr[0];
            }

            function set_cached_mii_image(mii_data, mii_image){
                const mii_data_key = `mii_${mii_data}`;
                const mii_data_arr = [mii_image, Date.now()];

                localStorage.setItem(mii_data_key, JSON.stringify(mii_data_arr));
            }

            function apply_mii_image(mii_data, mii_image){
                set_cached_mii_image(mii_data, mii_image);

                const mii_element = document.querySelector(`img[mii-data="${mii_data}"]`)

                if (!mii_element){
                    return;
                }

                mii_element.src = mii_image;
            }

            async function fetch_mii_images(mii_data_list){
                // Fetch Mii images
                let new_mii_data_list = [];

                // Handle cached images
                for (const mii_data of mii_data_list){
                    let mii_image = get_cached_mii_image(mii_data);

                    if (mii_image){
                        // Apply cached image
                        apply_mii_image(mii_data, mii_image);
                    } else {
                        // Fetch new image
                        new_mii_data_list.push(mii_data);
                    }
                }

                if (new_mii_data_list.length > MAX_MIIS_PER_REQUEST){
                    const mii_data_list_copy = new_mii_data_list.slice();
                    new_mii_data_list = mii_data_list_copy.splice(0, MAX_MIIS_PER_REQUEST);
                    fetch_mii_images(mii_data_list_copy);
                }

                if (new_mii_data_list.length > 0){
                    const mii_data_response = await fetch("https://umapyoi.net/api/v1/mii", {
                        method: "POST",
                        body: JSON.stringify(new_mii_data_list)
                    });

                    if (!mii_data_response.ok){
                        console.log("Error fetching Mii data from umapyoi.net");
                        return;
                    }

                    const mii_dict = await mii_data_response.json();

                    // console.log(mii_dict);

                    for (const mii_data of Object.keys(mii_dict)){
                        apply_mii_image(mii_data, mii_dict[mii_data]);
                    }
                }
            }


            async function autorun() {
                remove_expired_mii_images();

                const response = await fetch("https://umapyoi.net/api/v1/rr-rooms");
    
                if (!response.ok){
                    console.log("Error fetching room data from zplwii.xyz");
                    return;
                }


                const rooms = await response.json();
                let no_players = 0;
                // console.log(rooms);

                const tbody = document.getElementById("tablebody");

                const url = new URL(window.location.href);
                const params = url.searchParams;
                const filter_room = params.get("room");
                let room_not_found = true;


                for (const room of rooms) {
                    if (filter_room && room.id != filter_room){
                        continue;
                    }
                    room_not_found = false;

                    // Room Info
                    let tr = document.createElement("tr");
                    let th = document.createElement("th");
                    th.colSpan = 6;
                    th.classList.add("room-header");
                    let room_type = room.type == "anybody" ? "Public" : "Private";
                    let created = new Date(room.created);
                    let minutes_since = Math.floor((Date.now() - created) / 60000);
                    let hours_since = Math.floor(minutes_since / 60);
                    let final_time = minutes_since;
                    let format = "m"
                    if (minutes_since > 60) {
                        format = "h"
                        final_time = hours_since;
                    }

                    th.innerHTML = `${room_type} ${room.rk? room.rk.toUpperCase() + " " : ""}Room <a href="?room=${room.id}" class="room-link">${room.id}</a> | Uptime: ${final_time}${format}`;
                    tr.appendChild(th);
                    tbody.appendChild(tr);

                    // Data Headers
                    tr = document.createElement("tr");
                    tbody.appendChild(tr);
                    
                    // Mii Name
                    th = document.createElement("th");
                    th.textContent = "Mii Name";
                    tr.appendChild(th);

                    // Friend Code
                    th = document.createElement("th");
                    th.textContent = "Friend Code";
                    tr.appendChild(th);

                    // Mii
                    th = document.createElement("th");
                    th.textContent = "Mii";
                    tr.appendChild(th);

                    // Connection fail
                    th = document.createElement("th");
                    th.textContent = "Conn.\r\nFail";
                    tr.appendChild(th);

                    // VR
                    th = document.createElement("th");
                    th.textContent = "VR";
                    tr.appendChild(th);

                    // BR
                    th = document.createElement("th");
                    th.textContent = "BR";
                    tr.appendChild(th);


                    // Players
                    for (const player_idx of Object.keys(room.players)) {
                        no_players++;

                        tr = document.createElement("tr");
                        tbody.appendChild(tr);
                        
                        const player = room.players[player_idx];

                        // Mii Name
                        let td = document.createElement("td");
                        td.classList.add("mii-name");
                        td.textContent = 'mii' in player ? player.mii[0].name : player.name;
                        tr.appendChild(td);

                        // Friend Code
                        td = document.createElement("td");
                        td.textContent = player.fc;
                        if (player_idx == room.host){
                            td.style.fontWeight = "bold";
                        }
                        tr.appendChild(td);

                        // Mii
                            td = document.createElement("td");
                            img = document.createElement("img");
                            img.width = 64;
                            img.height = 64;
                            img.classList.add("mii");
                            img.src = "empty.png";
                            td.appendChild(img);
                            tr.appendChild(td);

                            if ('mii' in player){
                                img.setAttribute("mii-data", player.mii[0].data);
                            }

                        // Connection fail
                        td = document.createElement("td");
                        td.textContent = player.conn_fail;
                        tr.appendChild(td);

                        // VR
                        td = document.createElement("td");
                        td.textContent = player.ev;
                        tr.appendChild(td);

                        // BR
                        td = document.createElement("td");
                        td.textContent = player.eb;
                        tr.appendChild(td);
                    }

                }

                document.querySelector("#loading").style.display = "none";
                if (!filter_room){
                    document.querySelector("#no-rooms").textContent = rooms.length;
                    document.querySelector("#no-players").textContent = no_players;

                    document.querySelector("#top-container").style.display = "flex";
                }

                if (room_not_found){
                    document.querySelector("#top-container").style.display = "flex";
                    document.querySelector("#top-container").innerHTML = "<span style=\"color:red;\">Specified room has closed or does not exist.</span>";
                    return;
                }

                document.querySelector(".room-header").style.borderTop = "hidden";

                // Fetch Mii images
                let mii_data_list = [];

                for (const img_element of document.querySelectorAll("img[mii-data]")){
                    mii_data_list.push(img_element.getAttribute("mii-data"));
                }

                fetch_mii_images(mii_data_list);

            }
            if (document.addEventListener)
                document.addEventListener('DOMContentLoaded', autorun, false)
            else window.onload = autorun
        </script>
    </body>
</html>